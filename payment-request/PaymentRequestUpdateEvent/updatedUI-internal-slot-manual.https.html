<!doctype html>
<meta charset="utf8">
<link rel="help" href="">
<title>
</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
setup({ explicit_done: true, explicit_timeout: true });
const methods = [{ supportedMethods: "basic-card" }];
const details = {
  total: {
    label: "Total due",
    amount: { currency: "USD", value: "1.0" },
  },
  shippingOptions: [{
    id: "a-shipping-option",
    label: "Pass option",
    amount: { currency: "USD", value: "5.00" },
    selected: true,
  },]
};
const evilDetails = {
  total: {
    label: "FAIL",
    amount: { currency: "USD", value: "1000.0" },
  },
};
const options = { requestShipping: true };

test(() => {
  const request = new PaymentRequest(methods, details, options);
}, "Smoke test");

function testUpdatedUIChanged({ textContent: testName }) {
  promise_test(async t => {
    const request = new PaymentRequest(methods, details, options);
    request.addEventListener("shippingaddresschange", async ev => {
      // spin the event loop, sets updatedUI to true
      await Promise.resolve();
      ev.updateWith(details);
    });
    await promise_rejects(t, "InvalidStateError", request.show());
    const response = await responsePromise;
    await response.complete();
  }, testName.trim());
}

function testSubsequentUpdateWithCalls({ textContent: testName }) {
  promise_test(async t => {
    const request = new PaymentRequest(methods, details, options);
    const eventPromise = new Promise(resolve => {
      request.addEventListener("shippingaddresschange", async ev => {
        const p = Promise.resolve(details);
        ev.updateWith(p);
        await p;
        // throw, causing promise to auto-reject!
        ev.updateWith(evilDetails);
        resolve(); // we should never get to here.
      });
    });
    const responsePromise = request.show();
    await promise_rejects(t, "InvalidStateError", eventPromise);
    const response = await responsePromise;
    await response.complete();
  }, testName.trim());
}
</script>
<h2>updateWith() method</h2>
<p>
  When the payment sheet is shown, select a different shipping address once. Then pay.
</p>
<ol>
  <li id="test-0">
    <button onclick="testUpdatedUIChanged(this)">
      updateWith() must be called immediately.
    </button>
  </li>
  <li id="test-1">
    <button onclick="testSubsequentUpdateWithCalls(this); done();">
      Once the event has performed an update, subsequent calls to updateWith() must throw InvalidStateError.
    </button>
  </li>
</ol>
